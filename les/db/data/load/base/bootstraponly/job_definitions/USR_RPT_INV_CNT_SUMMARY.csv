job_id,role_id,name,enabled,type,command,log_file,trace_level,overlap,schedule,start_delay,timer,grp_nam
USR_RPT_INV_CNT_SUMMARY,,Aritzia Report - Inventory Count Summary,0,cron,"/* Summary of Inventory Adjustments*/
list warehouses
|
[SELECT count_date,
        cycle_count,
        manual_count,
        cnz,
        zero_count,
        fast_count,
        tot_loc,
        tot_units,
        adj_loc,
        net_adj,
        abs_adj,
        ROUND((CAST(tot_loc AS DECIMAL(10, 1)) - adj_loc) / tot_loc, 3) *100 loc_accu,
        ROUND((CAST(tot_units AS DECIMAL(10, 1)) + net_adj) / tot_units *100, 1) net_unit_accu,
        ROUND((CAST(tot_units AS DECIMAL(10, 1)) - abs_adj) / tot_units *100, 1) abs_unit_accu
   FROM (SELECT nvl(adj_sum.count_date, 'total') count_date,
                SUM(cnt_sum.cycle_count) cycle_count,
                SUM(cnt_sum.manual_count) manual_count,
                SUM(cnt_sum.cnz) cnz,
                SUM(cnt_sum.zero_count) zero_count,
                SUM(cnt_sum.fast_count) fast_count,
                SUM(cnt_sum.tot_loc) tot_loc,
                SUM(cnt_sum.tot_units) tot_units,
                SUM(adj_sum.adj_loc) adj_loc,
                SUM(adj_sum.net_adj) net_adj,
                SUM(adj_sum.abs_adj) abs_adj
           FROM (SELECT count_date,
                        adj_type,
                        COUNT(location) adj_loc,
                        SUM(adj_qty) net_adj,
                        SUM(abs_qty) abs_adj
                   FROM (SELECT cnt_a.count_date,
                                cnt_a.usr_id,
                                cnt_a.adj_type,
                                uc_prt.uc_merch_catg,
                                cnt_a.prtnum,
                                cnt_a.location,
                                SUM(cnt_a.adj_qty) adj_qty,
                                ABS(SUM(cnt_a.adj_qty)) abs_qty,
                                SUM(cnt_a.abs_qty_dly) all_adj_qty
                           FROM (select to_char(trndte, 'MM-DD-YYYY') count_date,
                                        usr_id,
                                        CASE WHEN oprcod = 'INVADJ'
                                         AND actcod = 'IDNTFY_AJ' THEN 'INVENTORY ADJUST'
                                             WHEN oprcod = 'INVADJ'
                                         AND actcod = 'INVDEL' THEN 'INVENTORY ADJUST'
                                             WHEN oprcod = 'CNTAUD'
                                         AND actcod = 'INVDEL' THEN 'COUNT AUDIT'
                                             WHEN oprcod = 'CNTAUD'
                                         AND actcod = 'IDNTFY' THEN 'COUNT AUDIT'
                                        END as adj_type,
                                        prtnum,
                                        CASE WHEN tostol LIKE 'PERM%' THEN trnqty* -1
                                             ELSE trnqty
                                        END adj_qty,
                                        CASE WHEN fr_arecod IN ('PICK', 'RESV', 'REVL', 'PROB', 'QA') THEN frstol
                                             WHEN to_arecod IN ('PICK', 'RESV', 'REVL', 'PROB', 'QA') THEN tostol
                                        END as location,
                                        wh_id,
                                        prt_client_id,
                                        trnqty abs_qty_dly
                                   FROm dlytrn
                                  WHERE actcod IN ('IDNTFY', 'INVADJ', 'IDNTFY_AJ', 'INVDEL')
                                    AND oprcod IN ('CNTAUD', 'INVADJ')
                                    AND trndte BETWEEN to_char(sysdate -14, 'YYYYMMDD')
                                    AND to_char(sysdate, 'YYYYMMDD')
                                    AND frinvs = 'AVL') cnt_a
                           LEFT
                           JOIN uc_prtmst uc_prt
                             on uc_prt.prtnum = cnt_a.prtnum
                            and uc_prt.prt_client_id = cnt_a.prt_client_id
                            and uc_prt.wh_id = cnt_a.wh_id
                           LEFT
                           JOIN prtmst pt
                             ON pt.prtnum = cnt_a.prtnum
                            and pt.wh_id_tmpl = cnt_a.wh_id
                            and pt.prt_client_id = cnt_a.prt_client_id
                          WHERE ((pt.wh_id_tmpl = 'DC01' AND pt.typcod = 'MODE') OR cnt_a.prtnum IS NULL)
                          GROUP BY cnt_a.count_date,
                                cnt_a.usr_id,
                                cnt_a.adj_type,
                                cnt_a.prtnum,
                                uc_prt.uc_merch_catg,
                                cnt_a.location) c1
                  GROUP BY count_date,
                        adj_type) adj_sum
           LEFT
           JOIN (SELECT cnt_date,
                        'COUNT AUDIT' cnt_join,
                        count(CASE WHEN cnttyp = 'C' THEN cnttyp
                              END) as cycle_count,
                        count(CASE WHEN cnttyp = 'MAN' THEN cnttyp
                              END) as manual_count,
                        count(CASE WHEN cnttyp = 'CNZ' THEN cnttyp
                              END) as cnz,
                        count(CASE WHEN cnttyp = 'Z' THEN cnttyp
                              END) as zero_count,
                        count(CASE WHEN cnttyp = 'FMC' THEN cnttyp
                              END) as fast_count,
                        count(stoloc) tot_loc,
                        SUM(untqty) tot_units
                   FROM (SELECT distinct cnt_date,
                                cnttyp,
                                stoloc,
                                untqty
                           FROM (SELECT to_char(cntdte, 'MM-DD-YYYY') cnt_date,
                                        cnttyp,
                                        stoloc,
                                        untqty
                                   FROM cnthst ch
                                   LEFT
                                   JOIN prtmst pt
                                     ON pt.prtnum = ch.prtnum
                                    and pt.wh_id_tmpl = ch.wh_id
                                    and pt.prt_client_id = ch.prt_client_id
                                  WHERE cntdte BETWEEN to_char(sysdate -14, 'YYYYMMDD')
                                    AND to_char(sysdate, 'YYYYMMDD')
                                    AND cnttyp IN ('C', 'CNZ', 'FMC', 'LOC', 'MAN', 'Z')
                                    AND ((pt.wh_id_tmpl = 'DC01' AND pt.typcod = 'MODE') OR ch.prtnum IS NULL)
                                 UNION ALL
                                 SELECT to_char(cntdte, 'MM-DD-YYYY') cnt_date,
                                        cnttyp,
                                        stoloc,
                                        untqty
                                   FROM cntwrk cw
                                   LEFT
                                   JOIN prtmst pt
                                     ON pt.prtnum = cw.prtnum
                                    and pt.wh_id_tmpl = cw.wh_id
                                  WHERE cntdte BETWEEN to_char(sysdate -14, 'YYYYMMDD')
                                    AND to_char(sysdate, 'YYYYMMDD')
                                    AND cnttyp IN ('C', 'CNZ', 'FMC', 'LOC', 'MAN', 'Z')
                                    AND ((pt.wh_id_tmpl = 'DC01' AND pt.typcod = 'MODE') OR cw.prtnum IS NULL)) c3) c4
                  GROUP BY cnt_date
                 having sum(untqty) > 0) cnt_sum
             ON cnt_sum.cnt_date = adj_sum.count_date
            AND cnt_sum.cnt_join = adj_sum.adj_type
          WHERE adj_type = 'COUNT AUDIT'
          GROUP BY rollup(count_date)) c5] >> res
|
expand environment variable
 where name = '$' || @wh_id || 'outputs' || '\Inventory Count Summary\'
|
publish data
 where path = @value
|
write csv file
 where resdata = @res
   and filnam = 'inventory_cnt_summary-' || to_char(sysdate, 'YYYYMMDD-HH24MISS') || '.csv'
   and path = @path;",$LESDIR/log/usr_rpt_cnt_summary.log,,0,"0 5 0 ? * * *",60,,usr_data
